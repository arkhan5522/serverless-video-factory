name: Universal Video Generator

on:
  repository_dispatch:
    types: [trigger-video]

jobs:
  run-video-factory:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Kaggle API
        run: pip install kaggle

      - name: Prepare Kaggle Script
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
          # MAPPING PAYLOAD DATA
          USER_MODE: ${{ github.event.client_payload.mode }}
          USER_TOPIC: ${{ github.event.client_payload.topic }}
          USER_SCRIPT: ${{ github.event.client_payload.script }}
          USER_DURATION: ${{ github.event.client_payload.duration }}
          USER_VOICE_PATH: ${{ github.event.client_payload.voice_path }}
          USER_LOGO_PATH: ${{ github.event.client_payload.logo_path }}
          USER_JOB_ID: ${{ github.event.client_payload.job_id }}
        run: |
          mkdir -p ~/.kaggle
          echo "{\"username\":\"$KAGGLE_USERNAME\",\"key\":\"$KAGGLE_KEY\"}" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

          # --- DYNAMIC SCRIPT BUILDER ---
          cat <<EOF > builder.py
          import os
          
          # Read the raw generator template
          with open('generator.py', 'r') as f:
              content = f.read()
          
          # Inject User Data into Placeholders
          replacements = {
              '{{MODE_PLACEHOLDER}}': os.environ.get('USER_MODE', 'topic'),
              '{{TOPIC_PLACEHOLDER}}': os.environ.get('USER_TOPIC', ''),
              '{{SCRIPT_PLACEHOLDER}}': os.environ.get('USER_SCRIPT', ''),
              '{{DURATION_PLACEHOLDER}}': os.environ.get('USER_DURATION', '3'),
              '{{VOICE_PATH_PLACEHOLDER}}': os.environ.get('USER_VOICE_PATH', ''),
              '{{LOGO_PATH_PLACEHOLDER}}': os.environ.get('USER_LOGO_PATH', ''),
              '{{JOB_ID_PLACEHOLDER}}': os.environ.get('USER_JOB_ID', 'debug_run')
          }
          
          for key, val in replacements.items():
              # Escape quotes and newlines for safety
              safe_val = str(val).replace('"', '\\"').replace('\\n', ' ')
              content = content.replace(key, safe_val)
          
          with open('final_script.py', 'w') as f:
              f.write(content)
          EOF

          python builder.py

          # --- METADATA (GPU ENABLED) ---
          # Note: 'enable_gpu': 'true' requests a GPU (usually T4 or P100 on Kaggle)
          echo '{
            "id": "'"$KAGGLE_USERNAME"'/video-factory-ultra",
            "title": "Video Factory Ultra",
            "code_file": "final_script.py",
            "language": "python",
            "kernel_type": "script",
            "is_private": "true",
            "enable_gpu": "true",
            "enable_internet": "true",
            "kernel_sources": [],
            "competition_sources": [],
            "dataset_sources": []
          }' > kernel-metadata.json

      - name: Push to Kaggle (GPU Mode)
        env:
           GH_PAT: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
           GEMINI_KEY: ${{ secrets.GEMINI_API_KEY }} 
           ASSEMBLY_KEY: ${{ secrets.ASSEMBLYAI_API_KEY }}
           PEXELS_KEYS: ${{ secrets.PEXELS_KEYS }}
           PIXABAY_KEYS: ${{ secrets.PIXABAY_KEYS }}
           GITHUB_REPOSITORY: ${{ github.repository }}
           GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          # Create Config Header
          echo "import os" > config_header.py
          echo "os.environ['GH_PAT'] = '$GH_PAT'" >> config_header.py
          echo "os.environ['GEMINI_API_KEY'] = '$GEMINI_KEY'" >> config_header.py
          echo "os.environ['ASSEMBLYAI_API_KEY'] = '$ASSEMBLY_KEY'" >> config_header.py
          echo "os.environ['PEXELS_KEYS'] = '$PEXELS_KEYS'" >> config_header.py
          echo "os.environ['PIXABAY_KEYS'] = '$PIXABAY_KEYS'" >> config_header.py
          echo "os.environ['GITHUB_REPOSITORY'] = '$GITHUB_REPOSITORY'" >> config_header.py
          echo "os.environ['GITHUB_TOKEN'] = '$GITHUB_TOKEN'" >> config_header.py

          # Merge Config + Script
          cat config_header.py final_script.py > temp.py && mv temp.py final_script.py
          
          # Initialize metadata explicitly if missing
          kaggle kernels init -p .
          
          # Force the metadata to be correct (Overwriting whatever init created)
          echo '{
            "id": "'"$KAGGLE_USERNAME"'/video-factory-ultra",
            "title": "Video Factory Ultra",
            "code_file": "final_script.py",
            "language": "python",
            "kernel_type": "script",
            "is_private": "true",
            "enable_gpu": "true",
            "enable_internet": "true",
            "dataset_sources": [],
            "kernel_sources": [],
            "competition_sources": []
          }' > kernel-metadata.json

          # PUSH WITHOUT --gpu FLAG (Metadata handles it)
          kaggle kernels push -p .
      - name: Wait for Result (Long Polling)
        run: |
          echo "Polling Kaggle (Timeout: 6 Hours)..."
          # Check status every minute for up to 6 hours
          for i in {1..360}; do
            OUTPUT=$(kaggle kernels status ${{ secrets.KAGGLE_USERNAME }}/video-factory-ultra)
            echo "$OUTPUT"
            
            if [[ "$OUTPUT" == *"complete"* ]]; then
              echo "✅ Kernel finished successfully!"
              break
            elif [[ "$OUTPUT" == *"error"* ]]; then
              echo "❌ Kernel failed! Check Kaggle logs."
              exit 1
            fi
            
            echo "Rendering... (Minute $i/360)"
            sleep 60
          done

      # Optional: Backup to Branch (Video is also on File.io)
      - name: Download Output
        continue-on-error: true
        run: |
          kaggle kernels output ${{ secrets.KAGGLE_USERNAME }}/video-factory-ultra -p ./output
          
          mkdir public_video
          mv ./output/final_video_*.mp4 ./public_video/ || echo "Video likely uploaded to File.io only."

      - name: Backup to Repo
        uses: peaceiris/actions-gh-pages@v3
        if: success()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public_video
          publish_branch: video-archive
          force_orphan: false
          keep_files: true
          user_name: 'Video Bot'
          user_email: 'bot@video.com'
          commit_message: 'Backup Video Render'
